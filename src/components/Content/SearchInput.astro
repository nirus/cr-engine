---

---

<section class="mx-auto max-w-3xl px-3">
  <div class="searchBoxContainer">
    <input
      type="text"
      id="searchBox"
      class="searchBox w-full rounded-lg border-2 border-gray-300 bg-white px-4 py-3 text-gray-900 placeholder-gray-500 transition-colors duration-200 focus:border-blue-500 focus:outline-none dark:border-slate-500 dark:bg-slate-800 dark:text-slate-100 dark:placeholder-slate-400"
      placeholder="Search articles..."
      data-test="search-input"
      autocomplete="off"
    />
    <div id="searchStatus" class="mt-2 hidden text-sm text-gray-500"></div>
  </div>

  <!-- Search Results -->
  <div id="searchResults" class="mt-6 space-y-4"></div>

  <script is:inline>
    let pagefind = null
    let searchTimeout = null
    let isLoading = false

    const debounce = (func, wait) => {
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(searchTimeout)
          func(...args)
        }
        clearTimeout(searchTimeout)
        searchTimeout = setTimeout(later, wait)
      }
    }

    const updateSearchStatus = message => {
      const statusEl = document.querySelector('#searchStatus')
      if (message) {
        statusEl.textContent = message
        statusEl.classList.remove('hidden')
      } else {
        statusEl.classList.add('hidden')
      }
    }

    const initPagefind = async () => {
      try {
        updateSearchStatus('Loading search...')
        pagefind = await import('/pagefind/pagefind.js')
        await pagefind.init()
        updateSearchStatus('')
      } catch (error) {
        console.error('Error loading Pagefind:', error)
        updateSearchStatus('Error loading search')
      }
    }

    const renderResults = async (results, query) => {
      const searchResults = document.querySelector('#searchResults')
      const MAX_PAGES = 15

      searchResults.innerHTML = ''

      if (!results.length) {
        const noResultsEl = document.createElement('div')
        noResultsEl.className =
          'p-6 bg-gray-50 rounded-lg border border-gray-200 text-center dark:bg-slate-800 dark:border-slate-600'
        noResultsEl.innerHTML = `
          <div class="text-gray-500 mb-2">
            <svg class="w-12 h-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <p class="text-lg font-medium">No results found</p>
            <p class="text-sm">Try different keywords or check your spelling</p>
          </div>
        `
        searchResults.appendChild(noResultsEl)
        return
      }

      const resultsContainer = document.createElement('div')
      resultsContainer.className = 'space-y-4'

      const countEl = document.createElement('div')
      countEl.className = 'text-sm text-gray-600 mb-4 dark:text-slate-400'
      countEl.textContent = `Found ${results.length} result${results.length !== 1 ? 's' : ''} for "${query}"`
      resultsContainer.appendChild(countEl)

      const sliced = results.slice(0, MAX_PAGES)
      const loaded = await Promise.all(sliced.map(r => r.data()))

      loaded.forEach(result => {
        const resultEl = document.createElement('div')
        resultEl.className =
          'p-4 bg-white rounded-lg border border-gray-200 hover:border-blue-300 hover:shadow-md transition-all duration-200 dark:bg-slate-800 dark:border-slate-600 dark:hover:border-blue-500'

        const titleEl = document.createElement('a')
        titleEl.className =
          'block text-lg font-semibold text-gray-900 hover:text-blue-600 transition-colors duration-200 mb-2 dark:text-slate-100 dark:hover:text-blue-400'
        titleEl.href = result.url
        titleEl.textContent = result.meta?.title || 'Untitled'
        resultEl.appendChild(titleEl)

        if (result.excerpt) {
          const excerptEl = document.createElement('div')
          excerptEl.className =
            'text-sm text-gray-600 leading-relaxed dark:text-slate-300'
          excerptEl.innerHTML = result.excerpt
          resultEl.appendChild(excerptEl)
        }

        resultsContainer.appendChild(resultEl)
      })

      searchResults.appendChild(resultsContainer)
    }

    const initUI = () => {
      const searchBox = document.querySelector('#searchBox')
      if (!searchBox) return

      const debouncedSearch = debounce(async query => {
        if (isLoading) return

        if (query.length < 2) {
          document.querySelector('#searchResults').innerHTML = ''
          updateSearchStatus('')
          return
        }

        if (!pagefind) {
          await initPagefind()
        }

        updateSearchStatus('Searching...')
        isLoading = true

        try {
          const search = await pagefind.search(query)
          await renderResults(search.results, query)
          updateSearchStatus('')
        } catch (error) {
          console.error('Search error:', error)
          updateSearchStatus('Search error occurred')
        } finally {
          isLoading = false
        }
      }, 300)

      searchBox.addEventListener('input', event => {
        const query = event.target.value.trim()
        debouncedSearch(query)
      })

      searchBox.addEventListener('keydown', event => {
        if (event.key === 'Escape') {
          searchBox.value = ''
          document.querySelector('#searchResults').innerHTML = ''
          updateSearchStatus('')
          searchBox.blur()
        }
      })

      searchBox.addEventListener('focus', async () => {
        if (searchBox.value.length >= 2 && pagefind) {
          const search = await pagefind.search(searchBox.value)
          await renderResults(search.results, searchBox.value)
        }
      })
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initUI)
    } else {
      initUI()
    }
  </script>

  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      const searchBox = document.getElementById('searchBox')
      if (searchBox) {
        setTimeout(() => searchBox.focus(), 100)
      }
    })
  </script>
</section>
