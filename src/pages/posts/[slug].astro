---
import TopBarNav from '@component/Navigation/TopBar.astro'
import BaseHead from '@component/Head/BaseHead.astro'
import BlogPost from '@component/Content/BlogPost.astro'
import Footer from '@component/Footer/Footer.astro'
import type { Props as AuthorProps } from '@component/Footer/PostFooter.astro'
import { fetchAuthor } from '@request/fetchAuthor'
import blogSlugToLegendImageData from '@layouts/BlogHero'
import { getCollection, render } from 'astro:content'
import type { InferGetStaticPropsType } from 'astro'
import { blogPostingJsonLd, breadcrumbJsonLd } from '@utils/jsonld'

export const prerender = true

export async function getStaticPaths() {
  const allPosts = await getCollection('posts')
  return allPosts.map(post => {
    const slug = post.id.replace(/\/index$/, '')
    return {
      params: { slug },
      props: { post },
    }
  })
}

type Props = InferGetStaticPropsType<typeof getStaticPaths>
const { post }: Props = Astro.props
const { title, description, pubDate, youtube, author, tags } = post.data
const slug = post.id.replace(/\/index$/, '')

const legendImage = blogSlugToLegendImageData(slug)

const ogImage = `/posts/${slug}/hero.jpg`

const userAgent = 'cr-engine@v1.0.0'

const authorDetails: AuthorProps | null = await fetchAuthor({
  author,
  userAgent,
}).then(details => (details?.name ? details : null))

const { Content } = await render(post)

const pubDateStr = pubDate.toISOString().split('T')[0]

const jsonLd = [
  blogPostingJsonLd({
    title,
    description,
    pubDate: pubDateStr,
    author,
    tags,
    slug,
    image: ogImage,
  }),
  breadcrumbJsonLd([
    { name: 'Home', url: '/' },
    { name: 'Posts', url: '/posts/' },
    { name: title, url: `/posts/${slug}/` },
  ]),
]

const articleMeta = {
  pubDate: pubDateStr,
  author: author || 'Coder Rocks',
  tags: tags || [],
}
---

<html lang={post.data.lang || 'en'}>
  <head>
    <BaseHead
      title={title}
      description={description}
      image={ogImage}
      articleMeta={articleMeta}
      jsonLd={jsonLd}
    />
  </head>

  <body class="dark:bg-slate-900 dark:text-slate-100">
    <TopBarNav />
    <main class="py-12" data-pagefind-body>
      <BlogPost
        title={title}
        tags={tags}
        legendImage={legendImage}
        pubDate={pubDate.toISOString()}
        youtube={youtube}
        author={authorDetails}
      >
        <Content />
      </BlogPost>
    </main>
    <Footer />
  </body>
</html>
