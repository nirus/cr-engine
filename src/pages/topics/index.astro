---
import BaseHead from '@component/Head/BaseHead.astro'
import TopBarNav from '@component/Navigation/TopBar.astro'
import Footer from '@component/Footer/Footer.astro'
import { Settings } from '@config/site'
import { normalizeTag } from '@utils/tags'
import { collectionPageJsonLd } from '@utils/jsonld'
import { getCollection } from 'astro:content'

const seoTitle = `Topics | ${Settings.site.title}`
const seoDescription =
  'Browse all topics on Coder Rocks â€” find articles by subject across AI-assisted development, coding, and modern engineering.'

const allPosts = await getCollection('posts')

const tagCounts = new Map<string, { display: string; count: number }>()
for (const post of allPosts) {
  const tags = post.data.tags
  if (!tags) continue
  for (const tag of tags) {
    const slug = normalizeTag(tag)
    const existing = tagCounts.get(slug)
    if (existing) {
      existing.count++
    } else {
      tagCounts.set(slug, { display: tag, count: 1 })
    }
  }
}

const sortedTags = [...tagCounts.entries()].sort(
  (a, b) => b[1].count - a[1].count,
)

const jsonLd = collectionPageJsonLd({
  name: 'Topics',
  description: seoDescription,
  url: '/topics/',
})
---

<html lang="en">
  <head>
    <BaseHead title={seoTitle} description={seoDescription} jsonLd={jsonLd} />
  </head>

  <body
    class="font-body personality-casual bg-white leading-normal text-black dark:bg-slate-900 dark:text-slate-100"
    data-pagefind-ignore="all"
  >
    <TopBarNav />

    <main
      class="bg-gradient-to-b from-zinc-50 to-white py-12 dark:from-slate-900 dark:to-slate-800"
    >
      <article class="mx-auto max-w-4xl px-4">
        <div class="mb-10 text-center">
          <h1
            class="text-3xl font-bold tracking-tight text-zinc-900 dark:text-white"
          >
            Topics
          </h1>
          <p class="mt-2 text-zinc-500 dark:text-slate-400">
            Browse articles by subject
          </p>
        </div>

        <div class="flex flex-wrap justify-center gap-3">
          {
            sortedTags.map(([slug, { display, count }]) => (
              <a
                href={`/topics/${slug}`}
                class="group inline-flex items-center gap-2 rounded-full border border-zinc-200 bg-white px-5 py-2.5 shadow-sm transition-all duration-200 hover:-translate-y-0.5 hover:border-sky-400 hover:shadow-md dark:border-slate-600 dark:bg-slate-800 dark:hover:border-sky-500"
              >
                <span class="text-sm font-medium text-zinc-700 capitalize group-hover:text-sky-600 dark:text-slate-200 dark:group-hover:text-sky-400">
                  {display}
                </span>
                <span class="inline-flex h-5 min-w-5 items-center justify-center rounded-full bg-zinc-100 px-1.5 text-xs font-semibold text-zinc-500 group-hover:bg-sky-100 group-hover:text-sky-700 dark:bg-slate-700 dark:text-slate-400 dark:group-hover:bg-sky-900 dark:group-hover:text-sky-300">
                  {count}
                </span>
              </a>
            ))
          }
        </div>
      </article>
    </main>
    <Footer />
  </body>
</html>
