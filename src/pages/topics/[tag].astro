---
import BaseHead from '@component/Head/BaseHead.astro'
import TopBarNav from '@component/Navigation/TopBar.astro'
import Card from '@component/Content/Card.astro'
import Footer from '@component/Footer/Footer.astro'
import { Settings } from '@config/site'
import { normalizeTag } from '@utils/tags'
import { collectionPageJsonLd, breadcrumbJsonLd } from '@utils/jsonld'
import { getCollection } from 'astro:content'
import type { GetStaticPathsResult } from 'astro'

export const prerender = true

export async function getStaticPaths(): Promise<GetStaticPathsResult> {
  const allPosts = await getCollection('posts')

  const tagPostsMap = new Map<
    string,
    { display: string; posts: typeof allPosts }
  >()
  for (const post of allPosts) {
    const tags = post.data.tags
    if (!tags) continue
    for (const tag of tags) {
      const slug = normalizeTag(tag)
      const existing = tagPostsMap.get(slug)
      if (existing) {
        existing.posts.push(post)
      } else {
        tagPostsMap.set(slug, { display: tag, posts: [post] })
      }
    }
  }

  return [...tagPostsMap.entries()].map(([slug, { display, posts }]) => ({
    params: { tag: slug },
    props: {
      displayName: display,
      posts: posts.sort(
        (a, b) =>
          new Date(b.data.pubDate).valueOf() -
          new Date(a.data.pubDate).valueOf(),
      ),
    },
  }))
}

const { tag } = Astro.params
const { displayName, posts } = Astro.props

const seoTitle = `${displayName} | ${Settings.site.title}`
const seoDescription = `Articles about ${displayName} on Coder Rocks â€” the agentic engineering blog.`

const jsonLd = [
  collectionPageJsonLd({
    name: displayName,
    description: seoDescription,
    url: `/topics/${tag}/`,
  }),
  breadcrumbJsonLd([
    { name: 'Home', url: '/' },
    { name: 'Topics', url: '/topics/' },
    { name: displayName, url: `/topics/${tag}/` },
  ]),
]
---

<html lang="en">
  <head>
    <BaseHead title={seoTitle} description={seoDescription} jsonLd={jsonLd} />
  </head>

  <body
    class="font-body personality-casual bg-white leading-normal text-black dark:bg-slate-900 dark:text-slate-100"
    data-pagefind-ignore="all"
  >
    <TopBarNav />

    <main
      class="bg-gradient-to-b from-zinc-50 to-white py-12 dark:from-slate-900 dark:to-slate-800"
    >
      <article class="mx-auto max-w-6xl px-4">
        <div class="mb-10 text-center">
          <nav class="mb-4 text-sm text-zinc-400 dark:text-slate-500">
            <a href="/topics" class="hover:text-sky-600 dark:hover:text-sky-400"
              >Topics</a
            >
            <span class="mx-1.5">/</span>
            <span class="text-zinc-600 dark:text-slate-300">{displayName}</span>
          </nav>
          <h1
            class="text-2xl font-semibold tracking-tight text-zinc-800 capitalize dark:text-slate-100"
          >
            {displayName}
          </h1>
          <p class="mt-1.5 text-sm text-zinc-400 dark:text-slate-500">
            {posts.length}
            {posts.length === 1 ? 'article' : 'articles'}
          </p>
        </div>

        <section
          class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3"
          data-test="articles-section"
        >
          {
            posts.map(p => (
              <div class="col-span-1">
                <Card post={p} />
              </div>
            ))
          }
        </section>

        <div class="mt-10 text-center">
          <a
            href="/topics"
            class="inline-flex items-center gap-1.5 text-sm text-zinc-400 transition-colors hover:text-sky-600 dark:text-slate-500 dark:hover:text-sky-400"
          >
            &larr; All topics
          </a>
        </div>
      </article>
    </main>
    <Footer />
  </body>
</html>
